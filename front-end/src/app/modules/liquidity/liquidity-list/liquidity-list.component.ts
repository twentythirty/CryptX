import { Component, OnInit } from '@angular/core';
import { ActivatedRoute, Router } from '@angular/router';
import { finalize } from 'rxjs/operators';

import { TableDataSource, TableDataColumn } from '../../../shared/components/data-table/data-table.component';
import { DataTableCommonManagerComponent } from '../../../shared/components/data-table-common-manager/data-table-common-manager.component';
import { StatusCellDataColumn, NumberCellDataColumn } from '../../../shared/components/data-table-cells';
import { LiquidityRequirement } from '../../../shared/models/liquidityRequirement';

import { LiquidityService } from '../../../services/liquidity/liquidity.service';

@Component({
  selector: 'app-liquidity-list',
  templateUrl: './liquidity-list.component.html',
  styleUrls: ['./liquidity-list.component.scss']
})
export class LiquidityListComponent extends DataTableCommonManagerComponent implements OnInit {
  public liquidityDataSource: TableDataSource = {
    header: [
      { column: 'instrument', nameKey: 'table.header.instrument', filter: { type: 'text', sortable: true } },
      { column: 'periodicity', nameKey: 'table.header.periodicity', filter: { type: 'number', sortable: true } },
      { column: 'quote_asset', nameKey: 'table.header.quote_asset', filter: { type: 'text', sortable: true } },
      { column: 'minimum_circulation', nameKey: 'table.header.minimum_circulation', filter: { type: 'number', sortable: true } },
      { column: 'exchange', nameKey: 'table.header.exchange', filter: { type: 'text', sortable: true } },
      { column: 'exchange_count', nameKey: 'table.header.exchange_count', filter: { type: 'number', sortable: true } },
      { column: 'exchange_not_pass', nameKey: 'table.header.exchange_not_pass', filter: { type: 'number', sortable: true } },
    ],
    body: null,
  };

  public liquidityColumnsToShow: Array<TableDataColumn> = [
    new TableDataColumn({ column: 'instrument' }),
    new TableDataColumn({ column: 'periodicity' }),
    new TableDataColumn({ column: 'quote_asset' }),
    new NumberCellDataColumn({ column: 'minimum_circulation', inputs: {
      digitsInfo: '1.2-2'
    } }),
    new StatusCellDataColumn({ column: 'exchange' }),
    new TableDataColumn({ column: 'exchange_count' }),
    new TableDataColumn({ column: 'exchange_not_pass' }),
  ];

  constructor(
    public route: ActivatedRoute,
    public router: Router,
    private liquidityService: LiquidityService,
  ) {
    super(route, router);
  }

  /**
   * Add a rowData$ Observable to text and boolean column filters
  */
  private getFilterLOV(): void {
    this.liquidityDataSource.header.filter(
      col => ['instrument', 'quote_asset', 'exchange'].includes(col.column)
    ).map(
      col => {
        col.filter.rowData$ = this.liquidityService.getHeaderLOV(col.column);
      }
    );
  }


  getAllData(): void {
    this.liquidityService.getAllLiquidities(this.requestData).pipe(
      finalize(() => this.stopTableLoading())
    ).subscribe(
      res => {
        Object.assign(this.liquidityDataSource, {
          body: res.liquidity_requirements,
          footer: res.footer
        });
        this.count = res.count;
        this.getFilterLOV();
      }
    );
  }

  openRow(liquidity: LiquidityRequirement): void {
    this.router.navigate(['/liquidity_requirements/preview', liquidity.id]);
  }

}
